<div class="page-container">
  <div class="page-header">
    <div class="header-text">
      <h2><mat-icon>history</mat-icon> My Service History</h2>
      <p class="subtitle">Track the status of your current and past service requests</p>
    </div>

    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search by category or issue</mat-label>
      <input matInput (input)="onSearch($event)" placeholder="e.g. Plumbing">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <mat-card class="custom-card">
    <table mat-table [dataSource]="requests()" class="uniform-table">
      
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef> Req # </th>
        <td mat-cell *matCellDef="let r"> #{{r.id}} </td>
      </ng-container>

      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef> Category </th>
        <td mat-cell *matCellDef="let r"> <strong>{{r.categoryName}}</strong> </td>
      </ng-container>

      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef> Priority </th>
        <td mat-cell *matCellDef="let r"> {{ getPriorityLabel(r.priority) }} </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Scheduled Date </th>
        <td mat-cell *matCellDef="let r"> {{r.scheduledDate | date:'medium'}} </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let r"> 
          <span class="status-badge" [ngClass]="getStatusClass(r)">
            {{ getStatusDisplay(r) }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="total">
        <th mat-header-cell *matHeaderCellDef> Total </th>
        <td mat-cell *matCellDef="let r"> â‚¹{{ getTotalPrice(r) }} </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let r">
          <button mat-button color="primary" [routerLink]="['/service-details', r.id]" matTooltip="View Details">
            View Details
          </button>
          <button mat-button color="accent" (click)="startReschedule(r); $event.stopPropagation()" [disabled]="!canCancel(r)" matTooltip="Reschedule">
            Reschedule
          </button>
          <button mat-button color="warn" (click)="cancelRequest(r.id); $event.stopPropagation()" [disabled]="!canCancel(r)" matTooltip="Cancel Request">
            Cancel Request
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator 
      [length]="totalCount()"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25]"
      (page)="onPageChange($event)"
      aria-label="Select page">
    </mat-paginator>

    <div *ngIf="requests().length === 0" class="empty-state">
      <mat-icon>history_toggle_off</mat-icon>
      <p>No requests found.</p>
    </div>
  </mat-card>

  <div *ngIf="reschedulingId !== null" class="reschedule-overlay">
    <mat-card class="reschedule-panel">
      <h3>Reschedule Request #{{reschedulingId}}</h3>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>New Date</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="rescheduleDate">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>New Time</mat-label>
          <input matInput type="time" [(ngModel)]="rescheduleTime">
        </mat-form-field>
      </div>
      <div class="action-row">
        <button mat-flat-button color="primary" (click)="submitReschedule(reschedulingId)">Confirm</button>
        <button mat-button (click)="cancelReschedule()">Cancel</button>
      </div>
    </mat-card>
  </div>
</div>